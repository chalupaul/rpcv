version: 2.1

DEPLOY_JOB_DEFAULTS: &DEPLOY_JOB_DEFAULTS
  docker:
    - image: ryandub/xplat-ci-images:latest
  environment:
    AWS_PROFILE: vdo-rpcv-dev
  working_directory: ~/vdo-rpcv
orbs:
  aws-cli: circleci/aws-cli@0.1.13
  aws-serverless: circleci/aws-serverless@1.0.2
commands:
  prep-s3:
    description: "Ensures s3 buckets exist"
    parameters:
      stage:
        type: string
    steps:
      - run: aws --profile vdo-rpcv-<< parameters.stage >> s3api head-bucket --bucket "vdo-rpcv-<< parameters.stage >>" >/dev/null 2>&1 ||  aws --profile vdo-rpcv-<< parameters.stage >> s3 mb s3://"vdo-rpcv-<< parameters.stage >>" --region us-west-2
jobs:
  build_dev:
    executor: aws-serverless/default
    steps:
      - checkout
      - aws-serverless/build:
          profile-name: vdo-rpcv-dev
          s3-bucket: vdo-rpcv-dev
          template: ./template.yaml
      - persist_to_workspace:
          root: ~/.aws-sam
          paths:
            - build
  deploy_dev:
    executor: aws-serverless/default
    steps:
      - attach_workspace:
          at: ~/.aws-sam
      - aws-serverless/deploy:
          profile-name: vdo-rpcv-dev
          stack-name: vdo-rpcv-dev
  auth_dev:
    executor: aws-serverless/default
    working_directory: ~/vdo-rpcv
    environment:
      AWS_REGION: us-west-2
    steps:
      - aws-serverless/install:
          aws-access-key-id: AWS_ACCESS_KEY_ID_DEV
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY_DEV
          aws-region: AWS_REGION_DEV
          profile-name: vdo-rpcv-dev
      - prep-s3:
          stage: dev
      - persist_to_workspace:
          root: ~/.aws
          paths:
            - "*"
workflows:
  release:
    jobs:
      - auth_dev
      - build_dev:
          requires:
            - aws_auth
      - deploy_dev:
          requires:
            - build_app_dev
